<!DOCTYPE html>
<html lang="en">

<head>
    <title>GIF Maker</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
        img {
            max-width: 200px;
            max-height: 200px;
            width: auto;
            height: auto;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="./index.html">Groep 4</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="./index.html">Home <span class="sr-only">(current)</span></a>
                </li>
            </ul>
        </div>
    </nav>
    <div>
        <h1>GIF Transformer</h1>
        <h2>WORK IN PROGRESS</h2>
        <div>
            <form autocomplete="off" id="form">
                <p>
                    <label>Select Images:</label>
                    <input type="file" id="images" multiple>
                </p>
                <p>
                    <label>E-mail: </label>
                    <input type="text" id="email">
                    <label>API KEY: </label>
                    <input type="text" id="apiKey">
                </p>
                <p>
                    <input type="submit" value="Upload Images and create a GIF"></input>
                </p>
                <button onclick="location.reload()">Cancel</button>
                <p>
                    <output id="result"></output>
                </p>
            </form>
        </div>
    </div>
    <div class="slideshow-container" id="result"></div>
</body>

<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<script>
    //Takes the file input from the from and adds an event listener that triggers a function on chage
    document.querySelector("#images").addEventListener("change", function() {
        const MAX_SIZE = 1000000; //Max file size in bits

        //Output for the form which will be emptied upon uploading new files
        var output = document.getElementById("result");
        output.innerHTML = "";

        //For loop for every file uploaded
        for (var i = 0; i < this.files.length; i++) {

            //remembers which file is currently being used
            var file = this.files[i];

            //adding a filereader to read the file object
            const reader = new FileReader();

            //Upon loading the file it will create a div element and put this in the output element as long as the file isn't bigger than the MAX_FILE_SIZE which will return an error
            reader.addEventListener("load", () => {
                var div = document.createElement("div");
                div.classList.add('gif');
                if (reader.result.length < MAX_SIZE) {
                    div.innerHTML = "<img src='" + reader.result + "'/>"
                    output.insertBefore(div, null);
                } else {
                    alert("File size is too large")
                }
            });
            reader.readAsDataURL(file);
        }
    });

    //Adds an event listener to the form, upon submit it will trigger a function
    document.querySelector("#form").addEventListener("submit", function(e) {
        e.preventDefault(); //Prevents the default behaviour from happening upon submitting the form like refreshing the page. 
        const API_PRESIGNEDURL = "https://tmgujo0ne5.execute-api.us-east-1.amazonaws.com/default/getPresignedURL"; //API URL for the presignedurl
        const API_GIFMAKER = "https://msw31oj97f.execute-api.eu-west-1.amazonaws.com/Prod/generate/gif" //API URL for the generate gif api
        let inputApiKey = document.getElementById("apiKey").value; //API key that validates if the user may access the API
        let email = document.getElementById("email").value; // Email where the GIFURL will be send to

        const data = document.querySelector("#images"); //Loads in all the uploaded files

        //For loop for every file uploaded
        for (var i = 0; i < data.files.length; i++) {

            //remembers which file is currently being used
            var file = data.files[i];

            //adding a filereader to read the file object
            const reader = new FileReader();

            //Defines the variable for the uploadURL which will be used later
            var uploadURL;

            //Event listener that triggers a method on load
            reader.addEventListener("load", () => {

                //API GET with the APIKEY as header to request access upon successful completion it will trigger the xhr() funtion
                // Header 'metadata' which contains the email. Now the uploaded image has metadata which is the email.
                const response = fetch(API_PRESIGNEDURL, {
                        method: 'GET',
                        headers: {
                            'X-Api-Key': inputApiKey,
                            'metadata' : email
                        },
                    })
                    .then(result => result.json())
                    .then((output) => {
                        uploadURL = output.uploadURL; //gets the presigned url
                        xhr();
                    })

                //Splits the datafile to be inputted in an array at the given index
                let binary = atob(reader.result.split(',')[1])
                let array = []
                for (var i = 0; i < binary.length; i++) {
                    array.push(binary.charCodeAt(i))
                }

                //Transforms files into a blob that can be uploaded as image type
                let blobData = new Blob([new Uint8Array(array)], {
                    type: 'image'
                })

                //Makes a PUT request at the uploadURL with the blobdata
                function xhr() {
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', uploadURL);
                    xhr.send(blobData);
                }

            });
            reader.readAsDataURL(file);
        }

        //Body with required info for the API to return an image in the given storage URL
        const imageData = {
            "inputImageUrls": [
                "https://i.pinimg.com/originals/a4/f8/f9/a4f8f91b31d2c63a015ed34ae8c13bbd.jpg",
                "https://i.pinimg.com/originals/20/79/03/2079033abc8314be554f9d24f562a199.jpg"
            ],
            "outputImageUrl": "http://requestbin.net/r/49szfjx7"
        }

        //Post request with the API key
        fetch(API_GIFMAKER, {
                method: 'POST',
                headers: {
                    'x-api-key': 'SIdHi3lzwma61h4GeBGR96ZD4rpsa3mb6iKVlMG7'
                },
                body: JSON.stringify(imageData)
            })
            .then(response => response.text())
            .then((response) => updateResponse(response))
            .catch(error => console.error(error));
    });

    /*{
			"name": "CreateGif",
			"request": {
				"auth": {
					"type": "apikey",
					"apikey": [
						{
							"key": "value",
							"value": "SIdHi3lzwma61h4GeBGR96ZD4rpsa3mb6iKVlMG7",
							"type": "string"
						},
						{
							"key": "key",
							"value": "x-api-key",
							"type": "string"
						},
						{
							"key": "in",
							"value": "header",
							"type": "string"
						}
					]
				},
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\n\t\"inputImageUrls\": [\n\t\t\"<image url of image to get>\",\n\t\t\"<a second frame?>\"\n\t],\n\t\"outputImageUrl\": \"<where to store the gif result>\"\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "https://msw31oj97f.execute-api.eu-west-1.amazonaws.com/Prod/generate/gif",
					"protocol": "https",
					"host": [
						"msw31oj97f",
						"execute-api",
						"eu-west-1",
						"amazonaws",
						"com"
					],
					"path": [
						"Prod",
						"generate",
						"gif"
					]
				}
			},
			"response": []
		}*/
</script>

</html>